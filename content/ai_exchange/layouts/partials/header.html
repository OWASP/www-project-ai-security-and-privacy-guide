<!-- Blue accent line -->
<!-- <div class="accent-line"></div> -->

<!-- Main header -->
<header class="main-header">
  <div class="header-background">
    <!-- <div class="circuit-pattern"></div>
    <div class="padlock-icon"></div> -->
  </div>
  
  <div class="container header-container">
    <!-- Logo Section -->
    <div class="logo-section">
      {{ if .Site.Params.navbar.displayLogo }}
        <a href="{{ .Site.Params.navbar.logo.link | default "/" }}" class="logo-link">
          <img 
            src="{{ .Site.Params.navbar.logo.path | relURL }}" 
            alt="{{ .Site.Title }}"
            class="site-logo"
            width="{{ .Site.Params.navbar.logo.width | default "auto" }}"
            height="{{ .Site.Params.navbar.logo.height | default "48" }}"
          />
        </a>
      {{ else if .Site.Params.navbar.displayTitle }}
        <a href="/" class="site-title-link">
          <span class="site-title">{{ .Site.Title }}</span>
        </a>
      {{ end }}
    </div>

    <!-- Desktop Navigation Menu -->
    <nav class="main-navigation desktop-nav">
      <ul class="nav-list">
        {{ range .Site.Menus.main }}
          <li class="nav-item">
            <a href="{{ .URL }}" class="nav-link {{ if eq $.RelPermalink .URL }}active{{ end }}">
              {{ .Name }}
            </a>
          </li>
        {{ end }}
      </ul>
    </nav>

    <!-- Header Actions -->
    <div class="header-actions">
      <!-- Desktop Social Icons -->
      <div class="social-icons desktop-social">
        {{ range .Site.Menus.social }}
          {{ if eq .Params.type "search" }}
            <!-- Search icon will be handled separately -->
          {{ else }}
            <a href="{{ .URL }}" class="social-link" title="{{ .Name }}">
              {{ if eq .Params.icon "github" }}
                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0C5.374 0 0 5.373 0 12 0 17.302 3.438 21.8 8.207 23.387c.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
                </svg>
              {{ else if eq .Params.icon "slack" }}
                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/>
                </svg>
              {{ else if eq .Params.icon "linkedin" }}
                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
              {{ else if eq .Params.icon "youtube" }}
                <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
              {{ end }}
            </a>
          {{ end }}
        {{ end }}
      </div>

      <!-- Search Icon -->
      <button class="search-icon" id="search-toggle" aria-label="Search">
        <svg class="search-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>

      <!-- Hamburger Icon (only on mobile) -->
      <button class="hamburger" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </div>
</header>

<!-- Search Overlay (Pagefind) -->
<div class="search-overlay" id="searchOverlay">
  <div class="search-container">
    <div class="search-header">
      <button class="search-close" id="search-close" aria-label="Close search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div id="pagefind-search" class="pagefind-search-container"></div>
  </div>
</div>

<!-- Full Screen Mobile Menu Overlay -->
<div class="mobile-menu-overlay" id="mobileMenu">
  <div class="mobile-menu-header">
    <!-- Mobile Logo Section -->
    <div class="mobile-logo-section">
      {{ if .Site.Params.navbar.displayLogo }}
        <a href="{{ .Site.Params.navbar.logo.link | default "/" }}" class="mobile-logo-link">
          <img 
            src="{{ .Site.Params.navbar.logo.path | relURL }}" 
            alt="{{ .Site.Title }}"
            class="mobile-site-logo"
            width="{{ .Site.Params.navbar.logo.width | default "auto" }}"
            height="{{ .Site.Params.navbar.logo.height | default "48" }}"
          />
        </a>
      {{ else if .Site.Params.navbar.displayTitle }}
        <a href="/" class="mobile-site-title-link">
          <span class="mobile-site-title">{{ .Site.Title }}</span>
        </a>
      {{ end }}
    </div>

    <!-- Close Button -->
    <button class="mobile-menu-close" aria-label="Close menu">
      <svg class="close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <!-- Mobile Navigation Menu -->
  <nav class="mobile-navigation">
    <ul class="mobile-nav-list">
      {{ range .Site.Menus.main }}
        <li class="mobile-nav-item">
          <a href="{{ .URL }}" class="mobile-nav-link {{ if eq $.RelPermalink .URL }}active{{ end }}">
            {{ .Name }}
          </a>
        </li>
      {{ end }}
      <!-- Search Link -->
      <li class="mobile-nav-item">
        <button class="mobile-nav-link text-center mobile-search-btn" onclick="document.getElementById('search-toggle').click()">
          <svg class="search-svg inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg> Search
        </button>
      </li>
    </ul>
  </nav>

  <!-- Mobile Social Icons -->
  <div class="mobile-social-icons">
    {{ range .Site.Menus.social }}
      {{ if and (ne .Params.type "search") (or (eq .Params.icon "linkedin") (eq .Params.icon "youtube") (eq .Params.icon "github")) }}
        <a href="{{ .URL }}" class="mobile-social-link" title="{{ .Name }}">
          {{ if eq .Params.icon "github" }}
            <svg class="mobile-social-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0C5.374 0 0 5.373 0 12 0 17.302 3.438 21.8 8.207 23.387c.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
            </svg>
          {{ else if eq .Params.icon "linkedin" }}
            <svg class="mobile-social-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          {{ else if eq .Params.icon "youtube" }}
            <svg class="mobile-social-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
          {{ end }}
        </a>
      {{ end }}
    {{ end }}
  </div>
</div>

<style>
/* Desktop Navigation Styles */
.main-navigation.desktop-nav {
  display: flex;
}

/* Search Icon Button */
.search-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-icon:hover {
  opacity: 0.8;
}

.search-svg {
  width: 20px;
  height: 20px;
  stroke: currentColor;
}

/* Hamburger Button Styles */
.hamburger {
  display: none;
  flex-direction: column;
  justify-content: space-between;
  width: 24px;
  height: 18px;
  background: none;
  border: none;
  cursor: pointer;
  z-index: 1001;
}

.hamburger span {
  display: block;
  height: 2px;
  width: 100%;
  background: #fff;
  border-radius: 2px;
  transition: all 0.3s ease;
}

.hamburger.active span:nth-child(1) {
  transform: rotate(45deg) translate(5px, 5px);
}

.hamburger.active span:nth-child(2) {
  opacity: 0;
}

.hamburger.active span:nth-child(3) {
  transform: rotate(-45deg) translate(7px, -6px);
}

/* Mobile Menu Overlay */
.mobile-menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: #002843;
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
    radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
    radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
    radial-gradient(circle at 10% 90%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
    radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
  background-size: 50px 50px, 80px 80px, 60px 60px, 40px 40px, 70px 70px;
  z-index: 9999;
  display: none;
  flex-direction: column;
  justify-content: space-between;
  padding: 0;
  overflow: hidden;
}

.mobile-menu-overlay.active {
  display: flex;
}

/* Mobile Menu Header */
.mobile-menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 2rem 2rem 1rem 2rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
}

.mobile-menu-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: rgba(255, 255, 255, 0.2);
}

.mobile-logo-section {
  flex: 1;
}

.mobile-site-logo {
  height: 48px;
  width: auto;
  filter: brightness(0) invert(1);
}

.mobile-site-title {
  color: white;
  font-size: 1.5rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.mobile-site-title-link {
  text-decoration: none;
}

.mobile-menu-close {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.mobile-menu-close:hover {
  background: rgba(255, 255, 255, 0.1);
}

.close-icon {
  width: 24px;
  height: 24px;
  stroke: white;
  stroke-width: 2;
}

/* Mobile Navigation */
.mobile-navigation {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.mobile-nav-list {
  list-style: none;
  margin: 0;
  padding: 0;
  width: 100%;
  max-width: 400px;
}

.mobile-nav-item {
  margin: 0;
}

.mobile-nav-link {
  display: block;
  color: white;
  text-decoration: none;
  font-weight: 500;
  font-size: 1.25rem;
  padding: 1.5rem 1rem;
  margin: 0.5rem 1rem;
  border-radius: 8px;
  transition: all 0.3s ease;
  position: relative;
  text-align: center;
}

.mobile-nav-link:hover {
  color: rgba(255, 255, 255, 0.8);
  background: rgba(255, 255, 255, 0.1);
}

.mobile-nav-link.active {
  background: #4CAF50;
  color: white;
  font-weight: 700;
}

.mobile-nav-link.active:hover {
  background: #45a049;
  color: white;
}

/* Mobile Social Icons */
.mobile-social-icons {
  display: flex;
  justify-content: center;
  gap: 2rem;
  padding: 2rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.mobile-social-link {
  color: white;
  text-decoration: none;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
}

.mobile-social-link:hover {
  color: #93c5fd;
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

.mobile-social-icon {
  width: 24px;
  height: 24px;
  fill: currentColor;
}

/* Mobile Styles */
@media (max-width: 768px) {
  .desktop-nav {
    display: none !important;
  }
  
  .desktop-social {
    display: none !important;
  }
  
  .hamburger {
    display: flex;
  }
  
  .search-icon {
    display: flex;
  }
  
  .header-container {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding-left: 1rem !important;
    padding-right: 1.5rem !important;
  }
  
  .logo-section {
    flex: 1;
  }
  
  .header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .site-logo {
    height: 40px;
    width: auto;
    filter: brightness(0) invert(1);
  }
  
  .site-title {
    font-size: 1.25rem;
  }
}

/* Desktop Styles */
@media (min-width: 769px) {
  .mobile-menu-overlay {
    display: none !important;
  }
}

/* Search Overlay Styles */
.search-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(10px);
  z-index: 9998;
  display: none;
  padding: 2rem;
}

.search-overlay.active {
  display: flex;
  flex-direction: column;
}

.search-container {
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
}

.search-header {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  margin-bottom: 1rem;
}

.search-close {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.search-close:hover {
  background: rgba(255, 255, 255, 0.2);
}

.search-close svg {
  width: 24px;
  height: 24px;
}

/* Pagefind UI container - match overlay dark theme */
.pagefind-search-container {
  --pagefind-ui-scale: 1;
  --pagefind-ui-primary: #4CAF50;
  --pagefind-ui-text: #fff;
  --pagefind-ui-background: rgba(255, 255, 255, 0.05);
  --pagefind-ui-border: rgba(255, 255, 255, 0.2);
  --pagefind-ui-border-width: 1px;
  --pagefind-ui-border-radius: 8px;
  --pagefind-ui-font: inherit;
  max-height: calc(100vh - 180px);
  overflow-y: auto;
}

/* Final attempt to fix Pagefind sub-results overlap by forcing extreme block separation */
#pagefind-search .pagefind-ui__result-nested {
  display: block !important;
  position: static !important;
  margin: 1.5rem 0 1.5rem 1.5rem !important;
  padding: 1rem !important;
  border-left: 4px solid #4CAF50 !important;
  background: rgba(255, 255, 255, 0.03) !important;
  height: auto !important;
  min-height: 50px !important;
  clear: both !important;
}

#pagefind-search .pagefind-ui__result-nested .pagefind-ui__result-title,
#pagefind-search .pagefind-ui__result-nested .pagefind-ui__result-excerpt {
  display: block !important;
  position: static !important;
  visibility: visible !important;
  opacity: 1 !important;
  width: 100% !important;
  height: auto !important;
  margin: 0 0 0.8rem 0 !important;
  padding: 0 !important;
  line-height: 1.5 !important;
  float: none !important;
}

#pagefind-search .pagefind-ui__result-nested .pagefind-ui__result-link {
  display: block !important;
  position: static !important;
  color: #4CAF50 !important;
  font-weight: 700 !important;
  text-decoration: underline !important;
}

#pagefind-search .pagefind-ui__result-nested .pagefind-ui__result-link::before,
#pagefind-search .pagefind-ui__result-nested .pagefind-ui__result-link::after {
  content: none !important;
  display: none !important;
}

/* Brief highlight on the element we scrolled to from ?highlight= */
.search-highlight-scroll {
  background: rgba(76, 175, 80, 0.2);
  transition: background 1.5s ease-out;
}

/* Highlight the matched word itself from ?highlight= */
.search-highlight-word {
  background: rgba(255, 235, 59, 0.65);
  padding: 0 0.1em;
  border-radius: 2px;
  transition: background 2s ease-out;
}
.search-highlight-word.fade-out {
  background: transparent;
}

.mobile-search-btn {
  background: none;
  border: none;
  cursor: pointer;
  width: 100%;
  margin: 0;
}
</style>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>

<script>
// Search overlay + Pagefind UI (run first on DOMContentLoaded so we're not blocked by other code)
document.addEventListener("DOMContentLoaded", () => {
  const searchToggle = document.getElementById("search-toggle");
  const searchOverlay = document.getElementById("searchOverlay");
  const searchClose = document.getElementById("search-close");

  if (typeof PagefindUI !== "undefined") {
    new PagefindUI({
      element: "#pagefind-search",
      translations: { placeholder: "Search articles, guides, and content..." },
      showSubResults: true,
      subResultsHierarchical: true,
      highlightParam: "highlight",
      showImages: false,
      resetStyles: false,
      autofocus: true
    });
  }

  // When clicking a result link, add current search query as ?highlight= so the destination page can scroll to the match
  const pagefindSearch = document.getElementById("pagefind-search");
  if (pagefindSearch) {
    pagefindSearch.addEventListener("click", (e) => {
      const link = e.target.closest("a[href]");
      if (!link || !link.href || !pagefindSearch.contains(link)) return;
      const searchInput = pagefindSearch.querySelector("input[type=\"search\"], input[type=\"text\"], .pagefind-ui__search-input, input");
      const query = searchInput && searchInput.value && searchInput.value.trim();
      // Prefer the matched term from the result (e.g. "foolbox" when user searched "foo") â€“ Pagefind wraps it in <mark>
      const resultRow = link.closest("li") || link.closest("[class*='result']") || link.parentElement;
      const matchEl = resultRow && resultRow.querySelector("mark, .pagefind-highlight, [class*='highlight']");
      const term = (matchEl && matchEl.textContent && matchEl.textContent.trim()) || query || (link.textContent && link.textContent.trim());
      if (!term) return;
      try {
        const u = new URL(link.href);
        if (u.origin !== location.origin) return;
        u.searchParams.set("highlight", term);
        e.preventDefault();
        location.assign(u.toString());
      } catch (_) {}
    }, true);
  }

  function focusSearchInput() {
    const input = pagefindSearch && pagefindSearch.querySelector("input[type=\"search\"], input[type=\"text\"], .pagefind-ui__search-input, input");
    if (input) {
      input.focus();
      return true;
    }
    return false;
  }

  function openSearch() {
    if (!searchOverlay) return;
    searchOverlay.classList.add("active");
    document.body.style.overflow = "hidden";
    // Pagefind injects its input asynchronously: retry focus until it appears (up to ~600ms)
    const tryFocus = (attempt) => {
      if (focusSearchInput()) return;
      if (attempt < 12) setTimeout(() => tryFocus(attempt + 1), 50);
    };
    setTimeout(() => tryFocus(0), 50);
  }

  if (searchToggle) {
    searchToggle.addEventListener("click", (e) => {
      e.preventDefault();
      openSearch();
    });
  }

  if (searchClose) {
    searchClose.addEventListener("click", () => {
      searchOverlay.classList.remove("active");
      document.body.style.overflow = "auto";
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && searchOverlay && searchOverlay.classList.contains("active")) {
      searchOverlay.classList.remove("active");
      document.body.style.overflow = "auto";
      return;
    }
    if (e.key === "/" && searchOverlay && !searchOverlay.classList.contains("active")) {
      const active = document.activeElement;
      const inInput = active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA" || active.isContentEditable);
      if (!inInput) {
        e.preventDefault();
        openSearch();
      }
    }
  });
});

// Mobile menu (separate callback so a null ref here doesn't kill search)
document.addEventListener("DOMContentLoaded", () => {
  const hamburger = document.querySelector(".hamburger");
  const mobileMenu = document.querySelector(".mobile-menu-overlay");
  const closeButton = document.querySelector(".mobile-menu-close");
  const mobileNavLinks = document.querySelectorAll(".mobile-nav-link");
  if (!hamburger || !mobileMenu || !closeButton) return;

  // Open mobile menu
  hamburger.addEventListener("click", () => {
    mobileMenu.classList.add("active");
    hamburger.classList.add("active");
    document.body.style.overflow = "hidden"; // Prevent background scrolling
  });

  // Close mobile menu
  closeButton.addEventListener("click", () => {
    mobileMenu.classList.remove("active");
    hamburger.classList.remove("active");
    document.body.style.overflow = "auto"; // Restore scrolling
  });

  // Close mobile menu when clicking on nav links
  mobileNavLinks.forEach(link => {
    link.addEventListener("click", () => {
      mobileMenu.classList.remove("active");
      hamburger.classList.remove("active");
      document.body.style.overflow = "auto";
    });
  });

  // Close mobile menu when clicking outside
  mobileMenu.addEventListener("click", (e) => {
    if (e.target === mobileMenu) {
      mobileMenu.classList.remove("active");
      hamburger.classList.remove("active");
      document.body.style.overflow = "auto";
    }
  });

  // Close mobile menu on escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && mobileMenu.classList.contains("active")) {
      mobileMenu.classList.remove("active");
      hamburger.classList.remove("active");
      document.body.style.overflow = "auto";
    }
  });
});

// Scroll to first occurrence of ?highlight= text in page content (e.g. after opening a result from search)
// Must run after DOM is ready so <main> and page content exist.
var _scrollHighlightDebug = true;
function getScrollParent(el) {
  var style = window.getComputedStyle(el);
  var overflowY = style.overflowY;
  var overflowX = style.overflowX;
  if ((overflowY === "auto" || overflowY === "scroll" || overflowX === "auto" || overflowX === "scroll") && el.scrollHeight > el.clientHeight) return el;
  if (el.parentElement && el.parentElement !== document.body) return getScrollParent(el.parentElement);
  return null;
}
function runScrollToHighlight() {
  const params = new URLSearchParams(location.search);
  const term = params.get("highlight");
  if (!term || !term.trim()) return;
  if ("scrollRestoration" in history) history.scrollRestoration = "manual";
  if (_scrollHighlightDebug) console.log("[scroll-highlight] runScrollToHighlight", { term: term, hasMain: !!document.querySelector("main"), mainChildCount: document.querySelector("main") && document.querySelector("main").childNodes.length });
  // Prefer main content only so we don't match sidebar/TOC (e.g. first "Foolbox" in docs is in .docs-body, not in nav)
  const container = document.querySelector(".docs-body") || document.querySelector(".docs-content") || document.querySelector("main.docs-main") || document.querySelector("main") || document.querySelector(".content") || document.querySelector("article") || document.body;
  if (_scrollHighlightDebug) console.log("[scroll-highlight] container", { tagName: container && container.tagName, id: container && container.id, className: container && container.className });
  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
  const needle = term.trim().toLowerCase();
  let node;
  let found = false;
  while ((node = walker.nextNode())) {
    if (node.textContent.toLowerCase().includes(needle)) {
      found = true;
      var text = node.textContent;
      var lower = text.toLowerCase();
      var idx = lower.indexOf(needle);
      if (idx !== -1) {
        var matchedText = text.substring(idx, idx + term.trim().length);
        var before = text.substring(0, idx);
        var after = text.substring(idx + matchedText.length);
        var span = document.createElement("span");
        span.className = "search-highlight-word";
        span.textContent = matchedText;
        var frag = document.createDocumentFragment();
        if (before) frag.appendChild(document.createTextNode(before));
        frag.appendChild(span);
        if (after) frag.appendChild(document.createTextNode(after));
        node.parentNode.replaceChild(frag, node);
        setTimeout(function () { span.classList.add("fade-out"); }, 20000);
      }
      var el = (span && span.parentElement) ? span.parentElement : node.parentElement;
      while (el && el !== container && !/^(P|LI|TD|TH|DIV|H[1-6]|BLOCKQUOTE|PRE|SECTION)$/i.test(el.tagName)) el = el.parentElement;
      if (_scrollHighlightDebug) console.log("[scroll-highlight] match", { elTag: el && el.tagName, scrollTarget: !!el && el !== document.body });
      if (el && el !== document.body) {
        el.classList.add("search-highlight-scroll");
        setTimeout(function () { el.classList.remove("search-highlight-scroll"); }, 2000);
        function doScroll() {
          var scrollParent = getScrollParent(el);
          if (scrollParent) {
            var parentRect = scrollParent.getBoundingClientRect();
            var elRect = el.getBoundingClientRect();
            var scrollTop = elRect.top - parentRect.top + scrollParent.scrollTop - (parentRect.height / 2) + (elRect.height / 2);
            scrollParent.scrollTop = Math.max(0, scrollTop);
            if (_scrollHighlightDebug) console.log("[scroll-highlight] scrolled div", scrollParent.className || scrollParent.id || scrollParent.tagName, "scrollTop", scrollParent.scrollTop);
          } else {
            el.scrollIntoView({ behavior: "auto", block: "center" });
            var rect = el.getBoundingClientRect();
            var docScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            var targetY = rect.top + docScrollTop - (window.innerHeight / 2) + (rect.height / 2);
            window.scrollTo({ top: Math.max(0, targetY), behavior: "auto" });
            if (_scrollHighlightDebug) console.log("[scroll-highlight] scrolled window to", targetY);
          }
        }
        
        // ONLY hijack the scroll if there is NO hash anchor in the URL.
        // If a hash exists (like a sub-result), let the browser jump to it natively!
        if (!window.location.hash) {
          requestAnimationFrame(function () { requestAnimationFrame(doScroll); });
          setTimeout(doScroll, 100);
          setTimeout(doScroll, 400);
        }
      }
      break;
    }
  }
  if (_scrollHighlightDebug) console.log("[scroll-highlight] found match?", found);
  params.delete("highlight");
  const clean = params.toString() ? location.pathname + "?" + params + location.hash : location.pathname + location.hash;
  history.replaceState(null, "", clean);
}
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", runScrollToHighlight);
} else {
  runScrollToHighlight();
}
</script>
